<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pokémon PDF Aleatorio con Fondo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
    }
    #controls {
        margin-bottom: 20px;
    }
</style>
</head>
<body>
<h1>Pokémon PDF Aleatorio</h1>
<div id="controls">
    <label for="orientation">Orientación:</label>
    <select id="orientation">
        <option value="portrait">Vertical</option>
        <option value="landscape">Horizontal</option>
    </select>
    <button id="generate">Generar PDF</button>
</div>

<script>
const btn = document.getElementById('generate');
const orientationSelect = document.getElementById('orientation');

const fondosLocales = [
    'fondos/fondo1.jpg',
    'fondos/fondo2.jpg',
    'fondos/fondo3.jpg'
];

async function fetchPokemons() {
    const promises = [];
    const usedIds = new Set();
    while (usedIds.size < 9) {
        const randomId = Math.floor(Math.random() * 898) + 1;
        if (!usedIds.has(randomId)) {
            usedIds.add(randomId);
            promises.push(fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`).then(res => res.json()));
        }
    }
    return Promise.all(promises);
}

function getUniqueNumbers() {
    const numbers = Array.from({length: 10}, (_, i) => i + 1);
    numbers.sort(() => Math.random() - 0.5);
    return numbers.slice(0, 9);
}

btn.onclick = async () => {
    const pokemons = await fetchPokemons();
    const numbers = getUniqueNumbers();
    generatePDF(pokemons, numbers);
};

async function generatePDF(pokemons, numbers) {
    const { jsPDF } = window.jspdf;
    const orientation = orientationSelect.value;
    const pdf = new jsPDF({
        orientation: orientation,
        unit: 'px',
        format: 'a4'
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const maxSize = 180;
    const minSize = 60;
    const step = (maxSize - minSize) / 9;

    // ✅ Fondo aleatorio
    const fondoAleatorio = fondosLocales[Math.floor(Math.random() * fondosLocales.length)];
    const backgroundImg = await loadImage(fondoAleatorio);
    pdf.addImage(backgroundImg, 'JPEG', 0, 0, pageWidth, pageHeight);

    // ✅ Colocar Pokémon en posicións aleatorias sen solapamento
    const posiciones = [];

    for (let i = 0; i < pokemons.length; i++) {
        const imgUrl = pokemons[i].sprites.other['official-artwork'].front_default;
        const img = await loadImage(imgUrl);

        const num = numbers[i];
        const size = maxSize - (num - 1) * step;

        let x, y;
        let intentos = 0;
        let valido = false;

        while (!valido && intentos < 100) {
            x = Math.random() * (pageWidth - size - 40) + 20;  // 20px marxe
            y = Math.random() * (pageHeight - size - 80) + 20; // 80px por pé de páxina
            valido = true;

            for (const pos of posiciones) {
                const dx = pos.x - x;
                const dy = pos.y - y;
                const distancia = Math.sqrt(dx * dx + dy * dy);
                if (distancia < (pos.size / 2 + size / 2) * 0.9) { // colisión
                    valido = false;
                    break;
                }
            }
            intentos++;
        }

        posiciones.push({x, y, size});

        // Engadir Pokémon
        pdf.addImage(img, 'PNG', x, y, size, size);

        // Círculo co número
        const circleRadius = size * 0.12;
        const circleX = x + size / 2;
        const circleY = y - circleRadius - 5;

        pdf.setFillColor(255, 0, 0);
        pdf.circle(circleX, circleY, circleRadius, 'F');

        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(circleRadius * 1.4);
        pdf.text(String(num), circleX, circleY + circleRadius * 0.4, { align: 'center' });

        // Nome do Pokémon abaixo
        pdf.setFontSize(8);
        pdf.setTextColor(0, 0, 0);
        pdf.text(pokemons[i].name.toUpperCase(), x + size / 2, y + size + 10, { align: 'center' });
    }

    // ✅ Pé de páxina
    pdf.setFontSize(8);
    pdf.setTextColor(100);
    pdf.text('diana deseñada por Pablo Belay Fernández (C) - 2025', pageWidth / 2, pageHeight - 10, { align: 'center' });

    pdf.save('pokemons.pdf');
}

function loadImage(url) {
    return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.src = url;
    });
}
</script>
</body>
</html>

