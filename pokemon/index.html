<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pokémon PDF Escalable con Configuración Completa</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
        background: #f7f7f7;
    }
    #controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0px 2px 6px rgba(0,0,0,0.2);
        display: inline-block;
    }
    #controls label {
        margin-right: 5px;
    }
    #controls select, #controls input {
        margin-right: 15px;
        padding: 3px 6px;
    }
    #pokemon-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, 150px);
        grid-gap: 20px;
        justify-content: center;
    }
    .pokemon-card {
        position: relative;
        width: 150px;
        height: 150px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        overflow: hidden;
        transition: transform 0.2s;
    }
    .pokemon-card:hover {
        transform: scale(1.05);
    }
    .pokemon-card img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    .circle-number {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: red;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 16px;
    }
</style>
</head>
<body>
<h1>Pokémon PDF Escalable</h1>
<div id="controls">
    <label for="orientation">Orientación:</label>
    <select id="orientation">
        <option value="portrait">Vertical</option>
        <option value="landscape">Horizontal</option>
    </select>

    <label for="fondo">Fondo:</label>
    <select id="fondo"></select>

    <label for="num-pokemons">Nº de Pokémon (1-10):</label>
    <input type="number" id="num-pokemons" min="1" max="10" value="9">

    <label for="transparency">Transparencia nº (0-1):</label>
    <input type="range" id="transparency" min="0" max="1" step="0.1" value="1">
    <span id="transparency-value">1.0</span>

    <label for="posicion-numero">Posición nº:</label>
    <select id="posicion-numero">
        <option value="centro">Centro</option>
        <option value="pe">Pé (xunto ao nome)</option>
    </select>

    <label for="layout">Disposición:</label>
    <select id="layout">
        <option value="grid">Cuadrícula</option>
        <option value="random">Aleatoria (sen solapamento)</option>
    </select>

    <button id="generate">Xerar PDF</button>
</div>
<div id="pokemon-container"></div>

<script>
const container = document.getElementById('pokemon-container');
const btn = document.getElementById('generate');
const orientationSelect = document.getElementById('orientation');
const fondoSelect = document.getElementById('fondo');
const numPokemonsInput = document.getElementById('num-pokemons');
const transparencyInput = document.getElementById('transparency');
const transparencyValue = document.getElementById('transparency-value');
const posicionNumeroSelect = document.getElementById('posicion-numero');
const layoutSelect = document.getElementById('layout');

// Lista de fondos locales
const fondosLocales = [
    'fondos/fondo1.jpg',
    'fondos/fondo2.jpg',
    'fondos/fondo3.jpg',
    'fondos/fondo4.jpg',
    'fondos/fondo5.jpg'
];

// Cargar opciones de fondos en el selector
fondosLocales.forEach((fondo, index) => {
    const option = document.createElement('option');
    option.value = fondo;
    option.textContent = `Fondo ${index + 1}`;
    fondoSelect.appendChild(option);
});

// Actualiza el texto de transparencia en tiempo real
transparencyInput.addEventListener('input', () => {
    transparencyValue.textContent = parseFloat(transparencyInput.value).toFixed(1);
});

async function fetchPokemons(count) {
    const promises = [];
    const usedIds = new Set();
    while (usedIds.size < count) {
        const randomId = Math.floor(Math.random() * 898) + 1;
        if (!usedIds.has(randomId)) {
            usedIds.add(randomId);
            promises.push(fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`).then(res => res.json()));
        }
    }
    return Promise.all(promises);
}

function getUniqueNumbers(count) {
    const numbers = Array.from({length: 10}, (_, i) => i + 1);
    numbers.sort(() => Math.random() - 0.5);
    return numbers.slice(0, count);
}

async function init() {
    const count = parseInt(numPokemonsInput.value);
    const pokemons = await fetchPokemons(count);
    const numbers = getUniqueNumbers(count);
    container.innerHTML = '';
    
    pokemons.forEach((poke, index) => {
        const div = document.createElement('div');
        div.className = 'pokemon-card';
        div.innerHTML = `
            <img src="${poke.sprites.other['official-artwork'].front_default}" alt="${poke.name}">
            <div class="circle-number">${numbers[index]}</div>
        `;
        container.appendChild(div);
    });

    btn.onclick = () => generatePDF(pokemons, numbers);
}

function isOverlapping(x, y, size, placed) {
    for (let p of placed) {
        const dx = p.x - x;
        const dy = p.y - y;
        const distance = Math.sqrt(dx*dx + dy*dy);
        if (distance < (p.size/2 + size/2)) {
            return true;
        }
    }
    return false;
}

function getRandomPosition(size, areaWidth, areaHeight, areaX, areaY, placed) {
    let attempts = 0;
    while (attempts < 1000) {
        const x = areaX + Math.random() * (areaWidth - size);
        const y = areaY + Math.random() * (areaHeight - size);
        if (!isOverlapping(x + size/2, y + size/2, size, placed)) {
            placed.push({ x: x + size/2, y: y + size/2, size });
            return { x, y };
        }
        attempts++;
    }
    return { x: areaX, y: areaY };
}

async function generatePDF(pokemons, numbers) {
    const { jsPDF } = window.jspdf;
    const orientation = orientationSelect.value;
    const pdf = new jsPDF({
        orientation: orientation,
        unit: 'px',
        format: 'a4'
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 20;

    const transparency = parseFloat(transparencyInput.value);
    const posicionNumero = posicionNumeroSelect.value;
    const layout = layoutSelect.value;
    const placed = [];

    // Fondo elegido
    const fondoSeleccionado = fondoSelect.value;
    const backgroundImg = await loadImage(fondoSeleccionado);
    pdf.addImage(backgroundImg, 'JPEG', 0, 0, pageWidth, pageHeight);

    for (let i = 0; i < pokemons.length; i++) {
        const imgUrl = pokemons[i].sprites.other['official-artwork'].front_default;
        const img = await loadImage(imgUrl);
        const num = numbers[i];

        let size = Math.floor(Math.random() * 70) + 80; // Tamaño aleatorio
        let x, y;

        if (layout === "grid") {
            const cols = 3;
            const rows = Math.ceil(pokemons.length / cols);
            const cellWidth = (pageWidth - margin * 2) / cols;
            const cellHeight = (pageHeight - margin * 2) / rows;
            const col = i % cols;
            const row = Math.floor(i / cols);
            x = margin + col * cellWidth + (cellWidth - size) / 2;
            y = margin + row * cellHeight + (cellHeight - size) / 2;
        } else {
            const areaX = margin;
            const areaY = margin;
            const areaWidth = pageWidth - margin*2;
            const areaHeight = pageHeight - margin*2;
            const pos = getRandomPosition(size, areaWidth, areaHeight, areaX, areaY, placed);
            x = pos.x;
            y = pos.y;
        }

        // Pokémon
        pdf.addImage(img, 'PNG', x, y, size, size);

        // Número
        if (posicionNumero === "centro") {
            const circleRadius = size * 0.12;
            const circleX = x + size / 2;
            const circleY = y + size / 2;

            pdf.setGState(new pdf.GState({ opacity: transparency }));
            pdf.setFillColor(255, 0, 0);
            pdf.circle(circleX, circleY, circleRadius, 'F');

            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(circleRadius * 1.5);
            pdf.text(String(num), circleX, circleY + circleRadius * 0.4, { align: 'center' });

            pdf.setGState(new pdf.GState({ opacity: 1 }));
        } else {
            pdf.setFontSize(12);
            pdf.setTextColor(255, 0, 0);
            pdf.text(`(${num})`, x + size / 2, y + size + 18, { align: 'center' });
        }

        // Nome
        pdf.setFontSize(8);
        pdf.setTextColor(0, 0, 0);
        pdf.text(pokemons[i].name.toUpperCase(), x + size / 2, y + size + 8, { align: 'center' });
    }

    // Pie de página
    pdf.setFontSize(8);
    pdf.setTextColor(100);
    pdf.text('Diana deseñada por Pablo Belay Fernández (C) - 2025', pageWidth / 2, pageHeight - 10, { align: 'center' });

    pdf.save('pokemons.pdf');
}

function loadImage(url) {
    return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.src = url;
    });
}

numPokemonsInput.addEventListener('change', init);

// Inicializar con valores por defecto
init();
</script>
</body>
</html>
